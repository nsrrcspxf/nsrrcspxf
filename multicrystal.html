<!DOCTYPE html> <!-- 文件型態宣告(固定) -->
<html lang="en">
<!-- head:網頁的額外資訊，不在主畫面內 -->

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VNEE4KVX62"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-VNEE4KVX62');
    </script>

    <!-- 控制裝置縮放維持在一倍-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" /> <!-- 網頁編碼是utf-8(萬國碼)-->

    <!-- 網頁標籤icon & 名稱-->
    <link rel="icon" type="image/png" href="img/NSRRC_logo3.jpg">
    <title> Calculation </title>

    <!-- Boostrap 導入程式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <!-- 連結Google提供的字體-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Amaranth|Fugaz One|Text Me One|Monoton" />
                                                                <!-- 三欄位內標題 | 大標題   |industry 內文|Navbar-SPXF --> 


    <!-- 連結自設的CSS樣式表-->
    <link rel="stylesheet" type="text/css" href="navbar-footer-gray.css" /> <!--導覽列樣式-->
    <link rel="stylesheet" type="text/css" href="multicrystal.css" />  

    <!-- 連結 Java Script 樣式 -->
    <script src="pointgroup.js"></script>  
   
</head>

<!-- body:網頁內文 -->

<body>
    <header>
        <!-- 第一區塊：導覽列 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <!-- Logo -->
                    <img src="img/NSRRC_logo3.jpg" width="50" height="50"
                        style="border-radius: 50%; margin-right: 15px;">
                <a class="navbar-brand" href="index.html">SPXF</a>

                <!-- 第一部分：手機版 -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#linkbar"
                    aria-controls="linkbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span> <!-- 產生下拉選單按鈕 -->
                </button>

                <!-- 第二部分：電腦版 -->
                <div class="collapse navbar-collapse" id="linkbar">

                    <!-- 導覽列內容 -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Home</a>
                            <!-- Beamline 下拉式選單 -->
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="index.html">Home</a>
                                <a class="dropdown-item" href="https://www.nsrrc.org.tw" target="_blank">NSRRC</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Beamline</a>
                            <!-- Beamline 下拉式選單 -->
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="TPS07A.html">TPS 07A</a>
                                <a class="dropdown-item" href="TPS05A.html">TPS 05A</a>
                                <a class="dropdown-item" href="TLS15A.html">TLS 15A</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Service</a>
                            <!-- Remote Access 下拉式選單 -->
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="user-support.html">User Support Service </a>
                                <a class="dropdown-item" href="RA.html">Remote Access</a>
                                <a class="dropdown-item" href="mail-in.html">Mail-in Service</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Schedule</a>
                            <!-- Schedule 下拉式選單 -->
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="support-schedule.html">Support Schedule</a>
                                <a class="dropdown-item" href="https://userportal.nsrrc.org.tw/APNSR/EX005/"
                                    target="_blank">Beamline Schedule</a>
                                <a class="dropdown-item" href="https://userportal.nsrrc.org.tw/APNSR/EX004/"
                                    target="_blank">Light Source Schedule</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="industry.html">Industry</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="staff.html">Staff</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="activites.html">Activites</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">User Info.</a>
                            <!-- User Information 下拉式選單 -->
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="https://userportal.nsrrc.org.tw/APNSR/index/"
                                    target="_blank">NSRRC User Portal </a>
                                <a class="dropdown-item" href="available-software.html">Available Software</a>
                                <a class="dropdown-item" href="acknowledgment-statements.html">Acknowledgment Statements</a>
                                <a class="dropdown-item" href="useful-links.html">Useful Links </a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="manual.html">Download</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="Tec-report.html">Technical Reports</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- 第二區塊：網頁上方圖片 -->
    <div class="text-center">
        <img src="Banner/Banner_1920_450_07A.svg" alt="Banner" class="banner">
    </div>

    <!-- 第三區塊：主標題 title-->
    <div class="title">Multi-crystal Data Collection</div>

    <!--第四區塊：表單-->
    <div class="container-fluid-main"> <!-- fluid: 水流樣式，for RWD -->
        <div class="row justify-content-center"> <!-- 水平置中 (col少的份數變成左右空白) -->   
            
            <!-- 中間欄位 -->
            <div class="col-12 col-lg-6 main-content"> <!-- 文字靠左(可自行設定)-->
                <!-- post:表單內容不會顯示在url中 ("get:會將標單內容顯示在url，不適於有個人訊息的資料") -->
                <form class="TCform" target="_self" method="post">
                    <fieldset style="max-width: 100%;"> <!--框架 -->
                        <legend> Information </legend> <!--標題 -->
                            <label for="pg">Space group：</label>                  <!-- pg: Point group-->
                            <select id="pg" name="PointGroup" onchange="updatenas()" >       <!-- nas: number of asymmetric-->
                                <option value="p1" selected>P1</option>
                                <option value="p2">P2/C2</option>
                                <option value="P222">P222/C222</option>
                                <option value="p4">P4</option>
                                <option value="p422">P422</option>
                                <option value="p3">P3</option>
                                <option value="p312">P312</option>
                                <option value="p321">P321</option>
                                <option value="p6">P6</option>
                                <option value="p622">P622</option>
                                <option value="i23">I23/P23</option>
                                <option value="i432">I432/P432</option>
                            </select>
                            <br> <!--換行 -->
                            <br> <!--再空一行 -->
                            <label for="nas">Number of asymmetric：</label>          <!-- nas: number of asymmetric-->
                            <input type="number" id="nas" name="NumberofAsymmetric" readonly>
                            <br> <!--換行 -->
                            <br> <!--再空一行 -->
                            <label for="deg"> Total oscillation range (max:180)： </label>
                            <input type="number" id="deg" name="TotalOscillationRange" size=5 value="10" step="0.1" required /> <!-- step="0.1": 指定填入數值需為1位數小數-->
                            <br> <!--換行 -->
                            <br> <!--再空一行 -->
                            <label for="mo"> Crystal mosaicity (from HKL2000 or Mosflm)： </label>
                            <input type="number" id="mo" name="CrystalMosaicity" size=5 value="0.50" step="0.01" required /> <!-- step="0.01": 指定填入數值需為2位數小數-->
                            <br> <!--換行 -->
                            <br> <!--再空一行 -->
                            <label for="nc"> Number of crystals： </label>
                            <input type="number" id="nc" name="NumberofCrystals" size=5 step="1" placeholder="填入正整數或留白"/> <!-- step="1": 指定填入數值需為整數-->
                            <br>
                            <br>
                    </fieldset>
                    <button type="button" onclick="calculate()">Calculate</button>
                </form>

                <!-- 提醒選擇 piont group -->
                <div id="alertArea" class="result"></div>

                <!-- 此部分表單因CSS設置，在網頁上為隱藏 -->
                <form class="epValue" target="_self" method="post">    
                    <fieldset style="max-width: 100%;"> <!--框架 -->
                        <legend> Result </legend> <!--標題 -->
                            <label for="evalue">Effect range：</label>          <!-- nas: number of asymmetric-->
                            <input type="number" id="evalue" name="EffectRange" readonly>
                            <br> <!--換行 -->
                            <br> <!--再空一行 -->
                            <label for="pvalue"> p value： </label>
                            <input type="number" id="pvalue" name="pvalue" readonly/> 
                            <br> <!--換行 --> 
                    </fieldset>
                </form>

                <form class="TCform" target="_self" method="post">
                    <fieldset style="max-width: 100%;"> <!--框架 -->
                        <legend> Result </legend> <!--標題 -->
                        <table class="center">    
                            <tr> <!--首列 -->   
                                <th colspan="2"> Native </th>       <!--th: 標準格 -->
                                <th colspan="2"> Anomalous </th>
                            </tr>
                            <tr> <!--第二列 -->
                                <td> Completeness (%) </td> <!--欄1 -->
                                <td> Average multiplicity </td> <!--欄2 -->
                                <td> Completeness (%) </td> <!--欄3 -->
                                <td> Average multiplicity </td> <!--欄3 -->
                            </tr>
                            <tr class="outvalue"> <!--第三列 -->
                                <td id="outC"> </td>                <!--td: 實際數據 -->
                                <td id="outaveM"> </td>
                                <td id="outanoC"> </td>
                                <td id="outanoaveM"> </td>
                            </tr>
                            <tr> <!--第四列 -->
                                <th colspan="4">  </th>
                            </tr>
                            <tr> <!--第五列 -->
                                <th colspan="4" id="howmanycrystals"> How many crystals do you need? </th>
                            </tr>
                            <tr> <!--第六列 -->
                                <th colspan="2"> Native </th>
                                <th colspan="2"> Anomalous </th>
                            </tr>
                            <tr> <!--第七列 -->
                                <td> Completeness 99.99% </td>
                                <td> Completeness 90.0% </td> 
                                <td> Completeness 99.99% </td>
                                <td> Completeness 90.0% </td>
                            </tr>
                            <tr class="outvalue"> <!--第八列 -->
                                <td id="outC999"> </td>
                                <td id="outC90"> </td>
                                <td id="outanoC999"> </td>
                                <td id="outanoC90"> </td>
                            </tr>
                        </table>
                        <br>
                    </fieldset>
                    <div class="note">
                        <p>* The prediction is relatively optimistic. You may need more crystals. 此估算值較為樂觀，實作上需要更多晶體。</p>
                        <p>*<b>Ref:</b> C.-Y. Huang, <i>et al.</i> <i>In meso in situ</i> serial X-ray crystallography of soluble and membrane proteins. <i>Acta Cryst.</i>, <b>(2015)</b> D71, 1238–1256.[doi: <a href="https://scripts.iucr.org/cgi-bin/paper?S1399004715005210"
                            target="_blank">10.1107/S1399004715005210.</a>]</p>
                    </div>
                </form> 
                <br>
            </div>   
        </div>
    </div>

    <script>
        // 確保在頁面加載時 updatenas 函數被調用，並且 nas 的初始值被正確設置。
        updatenas();

        // 主程式開始
        function calculate() {
            // 清空之前計算的結果
            document.getElementById("outC").innerHTML = "";
            document.getElementById("outanoC").innerHTML = "";
            document.getElementById("outaveM").innerHTML = "";
            document.getElementById("outanoaveM").innerHTML = "";
            document.getElementById("outC999").innerHTML = "";
            document.getElementById("outC90").innerHTML = "";
            document.getElementById("outanoC999").innerHTML = "";
            document.getElementById("outanoC90").innerHTML = "";

            // 在 calculate 函數的一開始將 'nc'' 'outC', 'outanoC', 'outaveM', 'outanoaveM' 的文字顏色設為預設顏色
            ['nc','outC', 'outanoC', 'outaveM', 'outanoaveM'].forEach(function (elementId) {
                var outputElement = document.getElementById(elementId);
                outputElement.innerHTML = "";
                outputElement.removeAttribute("style"); // 清空所有樣式
            });


            // 獲取輸入的值
            var nasValue = parseFloat(document.getElementById("nas").value);
            var degValue = parseFloat(document.getElementById("deg").value);
            var moValue = parseFloat(document.getElementById("mo").value);
            var ncValue = parseFloat(document.getElementById("nc").value);

            // 檢查 "deg" 和 "mo" 是否有填寫
            if (isNaN(degValue) || degValue <= 0 || isNaN(moValue) || moValue < 0) {
                showResultAlert("Please fill in 'Total oscillation range' and/or 'Crystal mosaicity' correctly. \n 請正確填寫 'Total oscillation range' 以及(或) 'Crystal mosaicity'。", "alert-warning");
                
                document.getElementById("deg").style.border = isNaN(degValue) || degValue <= 0 ? "2px solid red" : ""; //輸入框醒目提示
                document.getElementById("mo").style.border = isNaN(moValue) || moValue < 0 ? "2px solid red" : "";
                return;
            }

            // 檢查 "deg" 是否大於 180
            if (degValue > 180) {
                showResultAlert("Please enter a value for 'Total oscillation range' that is not greater than 180 degrees. \n 'Total oscillation range' 不可超過 180 度。", "alert-warning");
                document.getElementById("deg").style.border = "2px solid red"; // 輸入框醒目提示
                return;
            }
            
            // 如果填寫正確，清除提醒及邊框顏色
            document.getElementById("deg").style.border = ""; // 清除邊框顏色
            document.getElementById("mo").style.border = ""; // 清除邊框顏色
                
            // 計算 eValue
            var eValue = degValue - 2 * moValue;
            document.getElementById("evalue").value = eValue;

            // 計算 pValue
            var pValue = eValue / 180;
            document.getElementById("pvalue").value = pValue;

            // 計算 Completeness 99.99%, 需要多少顆晶體。 
            var outC999 = Math.ceil(Math.log(0.0001) / Math.log(1 - pValue) / (2 * nasValue));   //Math.ceil() 函數讓結果無條件進位至整數。
            var outC90 = Math.ceil(Math.log(0.1) / Math.log(1 - pValue) / (2 * nasValue));
            var outanoC999 = outC999 * 2
            var outanoC90 = outC90 * 2

            // 將計算結果填入表格
            document.getElementById("outC999").innerHTML = outC999.toFixed(0);
            document.getElementById("outC90").innerHTML = outC90.toFixed(0);
            document.getElementById("outanoC999").innerHTML = outanoC999.toFixed(0);
            document.getElementById("outanoC90").innerHTML = outanoC90.toFixed(0);

            // 檢查 "nc" 是否大於 0
            if (!isNaN(ncValue) && (ncValue <= 0 || Math.floor(ncValue) !== ncValue)) {
            showResultAlert("'Number of crystals' can be left blank or filled with a positive integer. \n 晶體數量可不填或填入正整數。", "alert-warning");
            document.getElementById("nc").style.border = isNaN(ncValue) || ncValue <= 0 || Math.floor(ncValue) !== ncValue? "2px solid red" : "";     //輸入框醒目提示
            return;
            }

            // 如果填寫正確，清除提醒及邊框顏色
            document.getElementById("nc").style.border = ""; // 清除邊框顏色

            if (!isNaN(ncValue)) {
                // 計算 outC、outanoC、outaveM、outanoaveM
                var outC = (1 - Math.pow((1 - pValue), ncValue * 2 * nasValue)) * 100;
                var outanoC = (1 - Math.pow((1 - pValue), ncValue * nasValue)) * 100;
                var outaveM = ncValue * pValue * 2 * nasValue;
                var outanoaveM = ncValue * pValue * nasValue;

                // 檢查計算結果是否為正值
                if (outC <= 0 || outanoC <= 0 || outaveM <= 0 || outanoaveM <= 0) {
                    showResultAlert("Crystal mosaicity is too high, try increasing the 'Total oscillation range'. \n 晶體 mosaicity 過大，可嘗試增加 'Total oscillation range'。", "alert-danger");
                    return; // 停止執行後續計算
                }

                // 將計算結果填入表格
                document.getElementById("outC").innerHTML = outC.toFixed(2);
                document.getElementById("outanoC").innerHTML = outanoC.toFixed(2);
                document.getElementById("outaveM").innerHTML = outaveM.toFixed(1);
                document.getElementById("outanoaveM").innerHTML = outanoaveM.toFixed(1);

                // 清空提醒區域
                document.getElementById("alertArea").innerHTML = "";
            }

            // 檢查 "nc" 是否已經有數值，如果是，則停止後續運算
            if (!isNaN(ncValue)) {
                return;
            }
                
            // 檢查 "nc" 是否為空白，如果為空白，則將"outC999"的數值用紅字填入"nc"輸入格中
            var ncInput = document.getElementById("nc");
            if (ncInput.value === "") {
                ncInput.value = outC999.toFixed(0);
                ncInput.style.color = "red";   // 設定文字顏色為紅色

                // 用"outC999"的數值計算 outC、outanoC、outaveM、outanoaveM，並將結果用紅字填入表格中
                ['outC', 'outanoC', 'outaveM', 'outanoaveM'].forEach(function (elementId) {
                    var value = calculateValue(elementId);
                    document.getElementById(elementId).innerHTML = value.toFixed(value === parseInt(value, 10) ? 0 : 2);
                    document.getElementById(elementId).style.color = "red";
                });
            }
            
            // 算式
            function calculateValue(elementId) {
                switch (elementId) {
                    case 'outC':
                        return (1 - Math.pow((1 - pValue), outC999 * 2 * nasValue)) * 100;
                    case 'outanoC':
                        return (1 - Math.pow((1 - pValue), outC999 * nasValue)) * 100;
                    case 'outaveM':
                        return outC999 * pValue * 2 * nasValue;
                    case 'outanoaveM':
                        return outC999 * pValue * nasValue;
                    default: 
                        return 0;    // default 是一個用來處理未知情況的保護機制。
                }
            }   
        }

        // showResultAlert 指令
        function showResultAlert(message, alertClass) {
            var alertArea = document.getElementById("alertArea");
            alertArea.innerText = message;
            alertArea.className = "alert " + alertClass;
            alertArea.style.display = "block";
            setTimeout(function () {
                alertArea.style.display = "none";
            }, 5000);  // 5秒後隱藏提醒
        }

    </script>
    
    <br>
    
    
   <!-- 最下層：底部 footer -->
   <footer>
        <div class="container" style="max-width: 85%;">
            <div class="row">
                <div class="col-12 col-md-3 my-auto nsrrcinfo">
                    <p style="font-weight: bold;">財團法人國家同步輻射研究中心</p>
                    <p>地址：300092 新竹市新安路101號 </p>
                    <p>電話：+886-3-578-0281</p>
                    <p>傳真：+886-3-578-9816</p>
                    <p>版權所有 © 2023 蛋白質繞射小組 </p>
                </div>
                <div class="col-12 col-md-4 my-auto nsrrcinfo">
                    <p style="font-weight: bold;">National Synchrotron Radiation Research Center (NSRRC)</p>
                    <p>101 Hsin-Ann Road, Hsinchu Science Park, Hsinchu 300092, Taiwan, R.O.C</p>
                    <p>TEL：+886-3-578-0281</p>
                    <p>FAX：+886-3-578-9816</p>
                    <p>Copyright © 2023 Protein Diffraction Group </p>
                </div>
                <div class="col-12 col-md-3 my-auto funding-agencies">
                    <p>Funding Agencies</p>
                    <div class="FA">
                        <a href="https://www.nstc.gov.tw/" target="_blank"><img src="img/NSTC.jpg" alt="NSTC"></a>
                    </div>
                    <div class="FA">
                        <a href="https://ncfb.nycu.edu.tw/index.html" target="_blank"><img src="img/NCFB.jpg" alt="NCFB"></a>
                    </div>
                </div>
                <div class="col-12 col-md-2 my-auto funding-agencies">
                    <p>Acknowledgment</p>
                    <p>Structure Courtesy of Dr. Chun-Jung Chen</p>
                </div>
            </div>
        </div>
    </footer>


</body>